Array.prototype.without=function(b){for(var a=0;a<this.length;a++){if(this[a]==b){this.splice(a,1);break}}};Array.prototype.clear=function(){this.length=0};Array.prototype.clone=function(){return this.slice(0)};Array.prototype.contains=function(b){for(var a=0;a<this.length;a++){if(this[a]==b){return true}}return false};Array.prototype.unique=function(){var b=[],a;this.sort();for(a=0;a<this.length;a++){if(this[a]!==this[a+1]){b[b.length]=this[a]}}return b};(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Object=function(){};Object.extend=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.initialize){this.initialize.apply(this,arguments)}}c.prototype=e;c.prototype.constructor=c;c.extend=arguments.callee;return c}})();cgsgColors={rgb2hex:function(d,c,a){return"#"+this._toHex(d)+this._toHex(c)+this._toHex(a)},hex2rgb:function(a){a=this._withoutSharp(a);return{r:parseInt(a.substring(0,2),16),g:parseInt(a.substring(2,4),16),b:parseInt(a.substring(4,6),16)}},_withoutSharp:function(a){return(a.charAt(0)=="#")?a.substring(1,a.length):a},_toHex:function(a){a=parseInt(a,10);if(isNaN(a)){return"00"}a=Math.max(0,Math.min(a,255));return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)}};var CGSGVector2D=Object.extend({initialize:function(a,b){this.x=a;this.y=b},copy:function(){return new CGSGVector2D(this.x,this.y)},add:function(a){this.x+=a.x;this.y+=a.y},substract:function(a){this.x-=a.x;this.y-=a.y},multiply:function(a){this.x*=a.x;this.y*=a.y},divide:function(a){this.x/=a.x;this.y/=a.y},multiplyByFloat:function(a){this.x*=a;this.y*=a},divideByFloat:function(a){this.x/=a;this.y/=a},getDistance:function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))},rotate:function(c){var b=Math.cos(c);var a=Math.sin(c);this.x=this.x*b+this.y*a;this.y=this.x*a-this.y*b},getLength:function(){return Math.sqrt((this.x*this.x)+(this.y*this.y))},getSquaredLength:function(){return(this.x*this.x)+(this.y*this.y)},normalize:function(){var b;var a=this.getLength();if(a==1||a==0){return}b=1/a;this.x*=b;this.y*=b}});var CGSGPosition=CGSGVector2D.extend({initialize:function(a,b){this._super(a,b)},copy:function(){return new CGSGPosition(this.x,this.y)},translateTo:function(b,a){this.x=b;this.y=a},translateWith:function(a,b){this.x+=a;this.y+=b},translateBy:function(a,b){this.x*=a;this.y*=b}});var CGSGScale=CGSGPosition.extend({initialize:function(a,b){this._super(a,b)}});var CGSGRotation=Object.extend({initialize:function(a){this.angle=a},copy:function(){return new CGSGRotation(this.angle)},rotateTo:function(a){this.angle=a},rotateBy:function(a){this.multiply(a)},rotateWith:function(a){this.add(a)},add:function(a){this.angle+=a},substract:function(a){this.angle-=a},multiply:function(a){this.angle*=a}});var CGSGDimension=CGSGVector2D.extend({initialize:function(b,a){this._super(b,a);this.width=this.x;this.height=this.y},copy:function(){return new CGSGDimension(this.width,this.height)},resizeTo:function(b,a){if(b>0){this.width=b}if(a>0){this.height=a}},resizeBy:function(b,a){if(b>0){this.width*=b}if(a>0){this.height*=a}},resizeWith:function(b,a){if(this.width+b>0){this.width+=b}if(this.height+a>0){this.height+=a}}});var CGSGRegion=Object.extend({initialize:function(b,d,c,a){this.position=new CGSGPosition(b,d);this.dimension=new CGSGDimension(c,a)},copy:function(){return new CGSGRegion(this.position.x,this.position.y,this.dimension.width,this.dimension.height)},add:function(a){this.position.translateWith(a.position.x,a.position.y);this.dimension.resizeWith(a.dimension.width,a.dimension.height)},substract:function(a){this.position.translateWith(-a.position.x,-a.position.y);this.dimension.resizeWith(-a.dimension.width,-a.dimension.height)}});var CGSG_DEFAULT_FRAMERATE=60;var CGSG_DEFAULT_DISPLAYRATIO=new CGSGScale(1,1);var CGSG_DEFAULT_SELECTED_STROKE_COLOR="#FF6890";var CGSG_DEFAULT_SELECTED_STROKE_SIZE=2;var CGSG_DEFAULT_SELECTED_RESIZEHANDLE_SIZE=6;var CGSG_DEFAULT_SELECTED_RESIZEHANDLE_COLOR="#9068FF";var CGSG_DEFAULT_SELECTED_RESIZEHANDLE_THRESHOLD=3;var CGSGTraverser=Object.extend({initialize:function(){this.lastResults=[]},traverse:function(a,c,b){this.lastResults.clear();this._check(a,c,b);return this.lastResults},_check:function(rootNode,condition,excludedNodes){if(rootNode.isTraversable===true){var exclusionExist=cgsgExist(excludedNodes)&&excludedNodes.length>0;if(!(exclusionExist&&excludedNodes.contains(rootNode))&&rootNode.eval(condition)===true){this.lastResults.push(rootNode)}for(var i=rootNode.children.length-1;i>=0;--i){var childNode=rootNode.children[i];this._check(childNode,condition,excludedNodes)}}}});var cgsgVersion="1.0.1";var cgsgDisplayRatio=CGSG_DEFAULT_DISPLAYRATIO;var cgsgResizeHandleThreshold=CGSG_DEFAULT_SELECTED_RESIZEHANDLE_THRESHOLD;var cgsgExplorerParams={IE10:{name:"IE 10 or above",textDecalYTop:4.3,textDecalYBottom:1.26,textDecalYMiddle:1.87,textDecalYAlpha:0.983,webworker:false},IE9:{name:"IE 9",textDecalYTop:4.3,textDecalYBottom:1.26,textDecalYMiddle:1.87,textDecalYAlpha:0.983,webworker:false},SAFARI:{name:"Safari",textDecalYTop:4,textDecalYBottom:1.27,textDecalYMiddle:1.77,textDecalYAlpha:0.983,webworker:false},CHROME:{name:"Chrome",textDecalYTop:3.3,textDecalYBottom:1.268,textDecalYMiddle:2.09,textDecalYAlpha:0.983,webworker:false},OPERA:{name:"Opera",textDecalYTop:3.5,textDecalYBottom:1.28,textDecalYMiddle:2,textDecalYAlpha:0.995,webworker:false},FIREFOX:{name:"Firefox",textDecalYTop:10,textDecalYBottom:1.23,textDecalYMiddle:1.77,textDecalYAlpha:0.983,webworker:false},KONQUEROR:{name:"Konqueror",textDecalYTop:10,textDecalYBottom:1.23,textDecalYMiddle:1.77,textDecalYAlpha:0.983,webworker:false},UNKNOWN:{name:"Unknown",textDecalYTop:10,textDecalYBottom:1.23,textDecalYMiddle:1.77,textDecalYAlpha:0.983,webworker:false}};var cgsgCurrentExplorer=cgsgExplorerParams.UNKNOWN;var cgsgGhostContext=null;var cgsgCurrentFrame=0;function cgsgExist(a){return(a!==null&&a!==undefined)}function cgsgDetectCurrentExplorer(){cgsgCurrentExplorer=cgsgExplorerParams.UNKNOWN;var c=navigator.userAgent;var d=navigator.appName;var e=""+parseFloat(navigator.appVersion);var a,b;if((b=c.indexOf("Opera"))!=-1){cgsgCurrentExplorer=cgsgExplorerParams.OPERA;e=c.substring(b+6);if((b=c.indexOf("Version"))!=-1){e=c.substring(b+8)}}else{if((b=c.indexOf("MSIE"))!=-1){d="Microsoft Internet Explorer";cgsgCurrentExplorer=cgsgExplorerParams.IE9;e=c.substring(b+5);if(parseInt(e)>=10){cgsgCurrentExplorer=cgsgExplorerParams.IE10}}else{if((b=c.indexOf("Chrome"))!=-1){cgsgCurrentExplorer=cgsgExplorerParams.CHROME;e=c.substring(b+7)}else{if((b=c.indexOf("Safari"))!=-1){cgsgCurrentExplorer=cgsgExplorerParams.SAFARI;e=c.substring(b+7);if((b=c.indexOf("Version"))!=-1){e=c.substring(b+8)}}else{if((b=c.indexOf("Firefox"))!=-1){cgsgCurrentExplorer=cgsgExplorerParams.FIREFOX;e=c.substring(b+8)}else{if((a=c.lastIndexOf(" ")+1)<(b=c.lastIndexOf("/"))){d=c.substring(a,b);e=c.substring(b+1);if(d.toLowerCase()==d.toUpperCase()){d=navigator.appName}}}}}}}if(typeof(Worker)!=="undefined"){cgsgCurrentExplorer.webworker=true}else{cgsgCurrentExplorer.webworker=false}};cgsgStylePaddingLeft=0;cgsgStylePaddingTop=0;cgsgStyleBorderLeft=0;cgsgStyleBorderTop=0;function cgsgGetRealViewportDimension(){var c=window,b="inner";if(!("innerWidth" in window)){b="client";c=document.documentElement||document.body}return new CGSGDimension(c[b+"Width"],c[b+"Height"])}function cgsgGetDisplayedViewportDimension(){var a=cgsgGetRealViewportDimension();return new CGSGDimension(Math.round(a.width/cgsgDisplayRatio.x),Math.round(a.height/cgsgDisplayRatio.y))}function cgsgPointIsInRegion(b,c,a){if(b.x>=(c.position.x-a)&&b.y>=(c.position.y-a)&&b.x<=(c.position.x+c.dimension.width+a)&&b.y<=(c.position.y+c.dimension.height+a)){return true}return false}function cgsgRegionIsInRegion(c,b,a){if(c.position.x>=(b.position.x-a)&&c.position.y>=(b.position.y-a)&&(c.position.x+c.dimension.width)<=(b.position.x+b.dimension.width+a)&&(c.position.y+c.dimension.height)<=(b.position.y+b.dimension.height+a)){return true}return false}function cgsgGetCursorPosition(d,b){var c=b,a=0,h=0,g=0,e=0;var f;if(d.targetTouches){f=d.targetTouches[0]}if(c.offsetParent){do{a+=c.offsetLeft;h+=c.offsetTop}while((c=c.offsetParent))}a+=cgsgStylePaddingLeft;h+=cgsgStylePaddingTop;a+=cgsgStyleBorderLeft;h+=cgsgStyleBorderTop;return new CGSGPosition((d.pageX-a)/cgsgDisplayRatio.x,(d.pageY-h)/cgsgDisplayRatio.y)};CGSGMath={PI2:Math.PI*2,deg2rad:function(a){return(a/180)*Math.PI},rad2deg:function(a){return a*57.29577951308232},fixedPoint:function(a){return(0.5+a)<<0}};var CGSGHandleBox=Object.extend({initialize:function(b,d,c,a,e){this.color=c;this.size=d;this._parentNode=b;this._position=new CGSGPosition(a,e)},render:function(a){a.fillStyle=this.color;a.fillRect(this._position.x,this._position.y,this.size/this._parentNode._absoluteScale.x,this.size/this._parentNode._absoluteScale.y)},checkIfSelected:function(b,a){return(b.x>=this._parentNode._absolutePosition.x+(this._position.x*this._parentNode._absoluteScale.x)-a&&b.x<=this._parentNode._absolutePosition.x+(this._position.x*this._parentNode._absoluteScale.x)+this.size+a&&b.y>=this._parentNode._absolutePosition.y+(this._position.y*this._parentNode._absoluteScale.y)-a&&b.y<=this._parentNode._absolutePosition.y+(this._position.y*this._parentNode._absoluteScale.y)+this.size+a)},translateTo:function(b,a){this._position.x=b;this._position.y=a}});var CGSGAnimationKey=Object.extend({initialize:function(b,a){this.frame=b;this.value=a}});var CGSGTimeline=Object.extend({initialize:function(a,b,c){this.parentNode=a;this.attribute=b;if(arguments.length==3){this.method=c}else{this.method="linear"}this.listValues=[];this._listKeys=[];this._listSteps=[];this.onAnimationStart=null;this.onAnimationEnd=null},addKey:function(b,a){this._listKeys.push(new CGSGAnimationKey(b,a));this.sortByFrame();if(this.getNbKeys()>1){this._computeStepsValues()}this.listValues.clear()},removeKey:function(c){var b=null;for(var a=0;a<this._listKeys.length-1;a++){if(this._listKeys[a].frame==c){b=this._listKeys[a];break}}this._listKeys.without(b);this._computeStepsValues();if(this.listValues.length>0){this.computeValues(0)}},removeAll:function(){this.listValues.clear();this._listKeys.clear();this._listSteps.clear()},_computeStepsValues:function(){this._listSteps.clear();var a=0;var b=0;for(var c=0;c<this._listKeys.length-1;c++){a=this._listKeys[c+1].frame-this._listKeys[c].frame;b=this._listKeys[c+1].value-this._listKeys[c].value;this._listSteps.push(b/a)}},getNbKeys:function(){return this._listKeys.length},sortByFrame:function(){this._listKeys.sort(function(d,c){return d.frame-c.frame})},computeValues:function(a,i){if(arguments.length==2){this.method=i}this.listValues.clear();var h=this.getNbKeys();if(h<=1){return}var e=0;var g=0;var d=0;var c=0;for(var b=0;b<h-1;++b){g=this._listKeys[b+1].frame-this._listKeys[b].frame;for(d=0;d<=g;++d){e=this.computeValue(b,this._listKeys[b].frame+d,i);this.listValues[c++]=e}}},computeValue:function(c,e,f){if(c<0){return undefined}var d=this._listKeys[c];var a=this._listKeys[c+1];if(e==d.frame){return{frame:e,value:d.value}}if(e==a.frame){return{frame:e,value:a.value}}var b=e-d.frame;if(f=="linear"){return{frame:e,value:b*this._listSteps[c]+d.value}}},getFirstKey:function(){if(this.getNbKeys()==0){return null}return this._listKeys[0]},getLastKey:function(){if(this.getNbKeys()==0){return null}return this._listKeys[this.getNbKeys()-1]},getValue:function(e){var f=this.getNbKeys();if(f==0&&this.listValues.length==0){return undefined}if(this.listValues.length==0){var d=-1;if(e<this._listKeys[0].frame){return undefined}for(var a=1;a<f;a++){if(e<this._listKeys[a].frame){d=a-1;break}}return this.computeValue(d,e,this.method)}if(e<this.listValues[0].frame){return undefined}if(e>=this.listValues[this.listValues.length-1].frame){return this.listValues[this.listValues.length-1]}var b=0;for(var c=0;c<this.listValues.length;c++){if(this.listValues[c].frame==e){return this.listValues[c]}}},exportValues:function(){if(this.listValues.length==0){this.computeValues(cgsgCurrentFrame,this.method)}var a=[];for(var b=0;b<this.listValues.length;b++){a.push(this.listValues[b].value)}return a},importValues:function(a,c){this.listValues.clear();for(var b=0;b<a.length;b++){this.listValues.push({frame:c+b,value:a[b]})}}});var CGSGPickNodeMethod={GHOST:"region",REGION:"region"};var CGSGNode=Object.extend({initialize:function(b,f,e,a){this.name="";this.isSelected=false;this.classType="CGSGNODE";this.resizeHandles=[];this.globalAlpha=1;this.isVisible=true;this.isProportionalResize=false;this.pickNodeMethod=CGSGPickNodeMethod.REGION;this.children=[];this.regionConstraint=null;this.rotationCenter=new CGSGPosition(0,0);this.userdata=null;this.isClickable=true;this.isResizable=false;this.isDraggable=false;this.selectionLineColor=CGSG_DEFAULT_SELECTED_STROKE_COLOR;this.selectionLineWidth=CGSG_DEFAULT_SELECTED_STROKE_SIZE;this.selectionHandleSize=CGSG_DEFAULT_SELECTED_RESIZEHANDLE_SIZE;this.selectionHandleColor=CGSG_DEFAULT_SELECTED_RESIZEHANDLE_COLOR;this.isMouseOver=false;this.isMoving=false;this.isResizing=false;this._id=0;this._parentNode=null;this.position=new CGSGPosition(0,0);this._absolutePosition=new CGSGPosition(0,0);this.dimension=new CGSGDimension(0,0);this.scale=new CGSGScale(1,1);this._absoluteScale=new CGSGScale(1,1);this.rotation=new CGSGRotation(0);this._absoluteRotation=new CGSGRotation(0);this._isDrag=false;this._ghostColor="#FF0000";this._isAbsoluteSRTObsolete=true;this.selectableZone=new CGSGRegion(this.position.x,this.position.y,this.dimension.width,this.dimension.height);this.isTraversable=true;this.translateTo(b,f);this.resizeTo(e,a);for(var d=0;d<8;d++){var c=new CGSGHandleBox(this,this.selectionHandleSize,this.selectionHandleColor,0,0);this.resizeHandles.push(c)}this.onMouseOver=null;this.onMouseOut=null;this.onClick=null;this.onDblClick=null;this.onDrag=null;this.onDragEnd=null;this.onResize=null;this.onResizeEnd=null;this.onSelect=null;this.onDeselect=null;this.computeAbsoluteMatrix(true)},getRegion:function(){return new CGSGRegion(this.position.x,this.position.y,this.getWidth(),this.getHeight())},getAbsoluteRegion:function(){return new CGSGRegion(this.getAbsoluteLeft(),this.getAbsoluteTop(),this.getAbsoluteWidth(),this.getAbsoluteHeight())},_clearContext:function(c,a,b){c.clearRect(0,0,a,b)},render:function(a){this.beforeRender(a);this.afterRender(a)},renderGhost:function(a){this.beforeRenderGhost(a);this.afterRenderGhost(a)},renderSelected:function(c){this._absolutePosition=this.getAbsolutePosition();this._absoluteScale=this.getAbsoluteScale();c.strokeStyle=this.selectionLineColor;c.lineWidth=this.selectionLineWidth/this._absoluteScale.y;c.beginPath();c.moveTo(0,0);c.lineTo(this.dimension.width,0);c.moveTo(0,this.dimension.height);c.lineTo(this.dimension.width,this.dimension.height);c.stroke();c.closePath();c.lineWidth=this.selectionLineWidth/this._absoluteScale.x;c.beginPath();c.moveTo(0,0);c.lineTo(0,this.dimension.height);c.moveTo(this.dimension.width,0);c.lineTo(this.dimension.width,this.dimension.height);c.stroke();c.closePath();if(this.isResizable){var d=this.selectionHandleSize/(2*this._absoluteScale.x);var b=this.selectionHandleSize/(2*this._absoluteScale.y);this.resizeHandles[0].translateTo(-d,-b);this.resizeHandles[1].translateTo(this.dimension.width/2-d,-b);this.resizeHandles[2].translateTo(this.dimension.width-d,-b);this.resizeHandles[3].translateTo(-d,this.dimension.height/2-b);this.resizeHandles[4].translateTo(this.dimension.width-d,this.dimension.height/2-b);this.resizeHandles[6].translateTo(this.dimension.width/2-d,this.dimension.height-b);this.resizeHandles[5].translateTo(-d,this.dimension.height-b);this.resizeHandles[7].translateTo(this.dimension.width-d,this.dimension.height-b);for(var a=0;a<8;a++){this.resizeHandles[a].size=this.selectionHandleSize;this.resizeHandles[a].color=this.selectionHandleColor;this.resizeHandles[a].render(c)}}},beforeRender:function(a){a.save();a.translate(this.position.x,this.position.y);a.translate(this.dimension.width*this.rotationCenter,this.dimension.height*this.rotationCenter);a.rotate(this.rotation.angle);a.scale(this.scale.x,this.scale.y)},afterRender:function(d){if(!this.isALeaf()){for(var c=0,a=this.children.length;c<a;++c){var b=this.children[c];if(b.isVisible){b.render(d)}}}d.restore()},beforeRenderGhost:function(a){a.save();a.translate(this._absolutePosition.x,this._absolutePosition.y);a.rotate(this._absoluteRotation.angle);a.scale(this._absoluteScale.x,this._absoluteScale.y)},afterRenderGhost:function(a){a.restore()},setSelected:function(a){this.isSelected=a;this._isDrag=true;if(a&&this.onSelect!==null){this.onSelect()}else{if(this.onDeselect!==null){this.onDeselect()}}},detectSelection:function(f,c,d,a,b){if(this.pickNodeMethod=="region"){if(f.x>=this._absolutePosition.x&&f.x<=this._absolutePosition.x+this.dimension.width*d.x&&f.y>=this._absolutePosition.y&&f.y<=this._absolutePosition.y+this.dimension.height*d.y){return this}}else{this.renderGhost(c);var e=c.getImageData(f.x,f.y,1,1);this._clearContext(c,a,b);if(e.data[0]!=0||e.data[1]!=0||e.data[2]!=0){return this}}return null},pickNode:function(mousePosition,absoluteScale,ghostContext,recursively,canvasWidth,canvasHeight,condition){var selectedNode=null;var childAbsoluteScale=null;if(cgsgExist(absoluteScale)){childAbsoluteScale=absoluteScale.copy();childAbsoluteScale.multiply(this.scale)}else{childAbsoluteScale=this.getAbsoluteScale()}if(this.isTraversable&&(this.isClickable||this.isResizable||this.isDraggable)){if(this.eval(condition)===true){this.computeAbsoluteMatrix(false);selectedNode=this.detectSelection(mousePosition,ghostContext,childAbsoluteScale,canvasWidth,canvasHeight)}}if(this.isTraversable&&recursively&&!this.isALeaf()){for(var i=this.children.length-1;i>=0;--i){var childNode=this.children[i];var selectedChild=childNode.pickNode(mousePosition,childAbsoluteScale,ghostContext,recursively,canvasWidth,canvasHeight,condition);if(selectedChild!==null&&selectedChild!==undefined){selectedNode=selectedChild;break}}childAbsoluteScale=null}return selectedNode},isALeaf:function(){return this.children.length<=0},translateTo:function(b,a,c){this.position.translateTo(b,a);if(c!==false){this._absolutePosition=this.getAbsolutePosition()}},translateWith:function(a,c,b){this.position.translateWith(a,c);if(b!==false){this._absolutePosition=this.getAbsolutePosition()}},translateBy:function(a,c,b){this.position.translateBy(a,c);if(b!==false){this._absolutePosition=this.getAbsolutePosition()}},resizeTo:function(b,a){this.dimension.resizeTo(b,a)},resizeBy:function(b,a){this.dimension.resizeBy(b,a)},resizeWith:function(d,a){var b=d,c=a;this.dimension.resizeWith(b,c)},scaleTo:function(b,a,c){this.scale.x=b;this.scale.y=a;if(c!==false){this._absoluteScale=this.getAbsoluteScale()}},scaleBy:function(a,c,b){this.scale.x*=a;this.scale.y*=c;if(b!==false){this._absoluteScale=this.getAbsoluteScale()}},scaleWith:function(a,c,b){this.scale.x+=scaleFactorX;this.scale.y+=scaleFactorY;if(b!==false){this._absoluteScale=this.getAbsoluteScale()}},rotateTo:function(b,a){this.rotation.rotateTo(b);if(a!==false){this._absoluteRotation=this.getAbsoluteRotation()}},rotateBy:function(a,b){this.rotation.rotateBy(a);if(b!==false){this._absoluteRotation=this.getAbsoluteRotation()}},rotateWith:function(b,a){this.rotation.rotateWith(b);if(a!==false){this._absoluteRotation=this.getAbsoluteRotation()}},addChild:function(a){a._parentNode=this;this.children[this.children.length]=a},addChildAt:function(c,a){if(a>this.children.length){a=this.children.length}for(var b=this.children.length;b>=a;--b){this.children[b]=this.children[b-1]}c.parentNode=this;this.children[a]=c},removeChild:function(e,f){var b=this.children.indexOf(e);if(b>=0){this.children.without(e);delete (e);return true}if(f){for(var d=0,a=this.children.length;d<a;++d){var c=this.children[d];if(c.removeChild(e,true)){return true}}}return false},removeAll:function(){for(var c=0,a=this.children.length;c<a;++c){var b=this.children[c];if(b.isALeaf()){delete (b)}else{b.removeAll()}}this.children.clear();this.initialize(0,0,10,10)},detachChildAt:function(a){if(a>=0&&a<this.children.length){this.detachChild(this.children[a])}},detachChild:function(a){a._parentNode=null;this.children.without(a)},evalSet:function(attribute,value){eval("this."+attribute+"="+value);if(attribute.indexOf("position")==0){this._absolutePosition=this.getAbsolutePosition()}else{if(attribute.indexOf("rotation")==0){this._absoluteRotation=this.getAbsoluteRotation()}else{if(attribute.indexOf("scale")==0){this._absoluteScale=this.getAbsoluteScale()}}}},eval:function(operation){if(operation===undefined||operation===null){return true}return eval("this."+operation)},setRegionConstraint:function(a){this.regionConstraint=a},getAbsolutePosition:function(){var b=this;var a=this.position.copy();while(b._parentNode!==null){a.multiply(b._parentNode.scale);b=b._parentNode}if(this._parentNode!==null){a.add(this._parentNode.getAbsolutePosition())}return a},getAbsoluteScale:function(){var b=this;var a=this.scale.copy();while(b._parentNode!==null){a.multiply(b._parentNode.scale);b=b._parentNode}return a},getAbsoluteRotation:function(){var b=this;var a=this.rotation.copy();while(b._parentNode!==null){a.add(b._parentNode.rotation.angle);b=b._parentNode}return a},computeAbsoluteMatrix:function(a){this._absolutePosition=this.getAbsolutePosition();this._absoluteScale=this.getAbsoluteScale();this._absoluteRotation=this.getAbsoluteRotation();if(a!==false){for(var b=0;b<this.children.length;b++){if(cgsgExist(this.children[b])){this.children[b].computeAbsoluteMatrix(a)}}}},getAbsoluteLeft:function(){return this._absolutePosition.x},getAbsoluteRight:function(){return this._absolutePosition.x+this.getAbsoluteWidth()},getAbsoluteTop:function(){return this._absolutePosition.y},getAbsoluteBottom:function(){return this._absolutePosition.y+this.getAbsoluteHeight()},getAbsoluteWidth:function(){return this.getWidth()*this._absoluteScale.x},getAbsoluteHeight:function(){return this.getHeight()*this._absoluteScale.y},getWidth:function(){return this.dimension.width},getHeight:function(){return this.dimension.height},isColliding:function(c,b){if(b===undefined||b===null){b=0}var a=c.getAbsoluteRight();var d=c.getAbsoluteBottom();if((this.getAbsoluteLeft()<=a+b&&this.getAbsoluteRight()>=c.getAbsoluteLeft()-b)||(this.getAbsoluteRight()>=c.getAbsoluteLeft()-b&&this.getAbsoluteLeft()<=a+b)){if(this.getAbsoluteTop()<=d+b&&this.getAbsoluteBottom()>=c.getAbsoluteTop()-b){return true}}return false},getListOfCollidingBrothers:function(a){var d=[];var b=null;for(var c=0;c<this._parentNode.children.length;c++){b=this._parentNode.children[c];if(b!==this&&this.isColliding(b,a)){d.push(b)}}return d},isCollidingABrother:function(a){var b=null;for(var c=0;c<this._parentNode.children.length;c++){b=this._parentNode.children[c];if(b!==this&&this.isColliding(b,a)){return true}}return false},copy:function(a){if(a===null||a===undefined){a=new CGSGNode(this.position.x,this.position.y,this.dimension.width,this.dimension.height)}a.classType=this.classType;a.name=this.name;a.globalAlpha=this.globalAlpha;a.isVisible=this.isVisible;a.isProportionalResize=this.isProportionalResize;a.pickNodeMethod=this.pickNodeMethod;if(this.regionConstraint!==null){a.regionConstraint=this.regionConstraint.copy()}if(this.userdata!==null){a.userdata=this.userdata.copy()}a.isClickable=this.isClickable;a.isResizable=this.isResizable;a.isDraggable=this.isDraggable;a.isTraversable=this.isTraversable;a.selectionLineColor=this.selectionLineColor;a.selectionLineWidth=this.selectionLineWidth;a.selectionHandleSize=this.selectionHandleSize;a.selectionHandleColor=this.selectionHandleColor;a._id=this._id;a._ghostColor=this._ghostColor;a.translateTo(this.position.x,this.position.y);a.resizeTo(this.dimension.width,this.dimension.height);a.scaleTo(this.scale.x,this.scale.y);a.rotateTo(this.rotation.angle);a.selectableZone=new CGSGRegion(a.position.x,a.position.y,a.dimension.width,a.dimension.height);a.onMouseOver=this.onMouseOver;a.onMouseOut=this.onMouseOut;a.onClick=this.onClick;a.onDblClick=this.onDblClick;a.onDrag=this.onDrag;a.onDragEnd=this.onDragEnd;a.onResize=this.onResize;a.onResizeEnd=this.onResizeEnd;a.onSelect=this.onSelect;a.onDeselect=this.onDeselect;a.computeAbsoluteMatrix(true);return a}});var CGSGWrapMode={WORD:{space:" "},LETTER:{space:""},SENTENCE:{space:"."}};var CGSGNodeText=CGSGNode.extend({initialize:function(a,c,b){this._super(a,c,-1,-1);this._text="";this.color="#444444";this._size=18;this._textAlign="left";this._textBaseline="top";this._stroke=false;this._typo="Arial";this._maxWidth=-1;this._lineHeight=this._size;this._wrapMode=CGSGWrapMode.LETTER;this._sections=[];this._tabulation="    ";this.pickNodeMethod="ghost";this.metrics={width:1};this._nbLines=1;this.classType="CGSGNodeText";this.setText(b);this.resizeTo(this.getWidth(),this.getHeight())},setWrapMode:function(b,a){this._wrapMode=b;if(a!==false){this.computeRealDimension()}},setTabulationString:function(b,a){this._tabulation=b;this._text=this._text.replace(/(\t)/g,this._tabulation);if(a!==false){this.computeRealDimension()}},setStroke:function(b,a){this._stroke=b;if(a!==false){this.computeRealDimension()}},setText:function(b,a){this._text=b;this._text=this._text.replace(/(\r\n|\n\r|\r|\n)/g,"\n");this._text=this._text.replace(/(\t)/g,this._tabulation);this._sections=this._text.split("\n");if(a!==false){this.computeRealDimension()}},setSize:function(b,a){this._size=b;if(a!==false){this.computeRealDimension()}},setTextAlign:function(b){this._textAlign=b},setTextBaseline:function(a,c){this._textBaseline=a;if(c!==false){this.computeRealDimension()}},setTypo:function(b,a){this._typo=b;if(a!==false){this.computeRealDimension()}},setMaxWidth:function(a,b){this._maxWidth=a;this.resizeTo(a,this.getHeight());if(b!==false){this.computeRealDimension()}},setLineHeight:function(b,a){this._lineHeight=b;if(a!==false){this.computeRealDimension()}},computeRealDimension:function(){this.metrics.width=0;var b=document.createElement("canvas");b.height=800;b.width=1000;var a=b.getContext("2d");this._doRender(a);b.width=0;b.height=0;delete (b)},render:function(a){this.beforeRender(a);a.fillStyle=this.color;this._doRender(a);this.afterRender(a)},_doRender:function(d,h){d.font=this._size+"pt "+this._typo;d.textAlign=this._textAlign;d.textBaseline=this._textBaseline;var i=0;var f=0;var b=0;var a=0;if(isNaN(this._maxWidth)||this._maxWidth<=0){b=this._computeDecalX(this.getWidth());for(i=0;i<this._sections.length;i++){f=d.measureText(this._sections[i]).width;this._drawText(this._sections[i],b,a,d,h,f);a+=this._lineHeight}this._nbLines=this._sections.length}else{this._nbLines=0;for(i=0;i<this._sections.length;i++){var g=this._sections[i].split(this._wrapMode.space);var c=1;var e=g[0];a=0;f=0;while(c<g.length){while((f=d.measureText(e).width)<this._maxWidth&&c<g.length){if(e!=""){e+=this._wrapMode.space}e+=g[c++]}f=d.measureText(e).width;a=this._nbLines*this._lineHeight;b=this._computeDecalX(this.getWidth());this._drawText(e,b,a,d,h,f);this._nbLines++;e="";f=0}}}},_drawText:function(f,a,g,c,e,d){if(e===true){return this._drawSquare(a,g,d,c)}if(this._stroke){c.strokeText(f,a,g)}else{c.fillText(f,a,g)}var b=c.measureText(f);if(b.width>this.metrics.width){this.metrics.width=b.width}},_drawSquare:function(a,d,c,b){b.fillRect(a-this._computeDecalX(c),d+this._computeDecalY(),c,this._size*1)},getHeight:function(){if(this._nbLines==0){return this._nbLines}else{if(this._nbLines==1){return this._size}}return(this._nbLines*this._size)+((this._nbLines-1)*(this._lineHeight-this._size))},getWidth:function(){return this.metrics.width},_computeDecalX:function(b){var a=0;if(this._textAlign=="start"||this._textAlign=="left"){a=0}else{if(this._textAlign=="center"){a=b/2}else{if(this._textAlign=="end"||this._textAlign=="right"){a=b}}}return a},_computeDecalY:function(){var a=0;if(this._textBaseline=="top"||this._textBaseline=="hanging"){a=this._size/cgsgCurrentExplorer.textDecalYTop}else{if(this._textBaseline=="middle"){a=-this._size/cgsgCurrentExplorer.textDecalYMiddle}else{if(this._textBaseline=="alphabetic"||this._textBaseline=="ideographic"){a=-this._size*cgsgCurrentExplorer.textDecalYAlpha}else{if(this._textBaseline=="bottom"){a=-this._size*cgsgCurrentExplorer.textDecalYBottom}}}}return a},renderGhost:function(a){this.beforeRenderGhost(a);a.fillStyle=this._ghostColor;this._doRender(a,true);this.afterRenderGhost(a)},renderSelected:function(e){var h=0;var d=this._computeDecalY();this._absolutePosition=this.getAbsolutePosition();this._absoluteScale=this.getAbsoluteScale();var a=this.getHeight();var g=this.getWidth();e.strokeStyle=this.selectionLineColor;e.lineWidth=this.selectionLineWidth/this._absoluteScale.y;e.beginPath();e.moveTo(h,d);e.lineTo(g,d);e.moveTo(h,d+a);e.lineTo(g,d+a);e.stroke();e.closePath();e.lineWidth=this.selectionLineWidth/this._absoluteScale.x;e.beginPath();e.moveTo(h,d);e.lineTo(h,d+a);e.moveTo(h+g,d);e.lineTo(h+g,d+a);e.stroke();e.closePath();if(this.isResizable){var f=this.selectionHandleSize/(2*this._absoluteScale.x);var c=this.selectionHandleSize/(2*this._absoluteScale.y);this.resizeHandles[0].translateTo(-f,-c+d);this.resizeHandles[1].translateTo(g/2-f,-c+d);this.resizeHandles[2].translateTo(g-f,-c+d);this.resizeHandles[3].translateTo(-f,a/2-c+d);this.resizeHandles[4].translateTo(g-f,a/2-c+d);this.resizeHandles[6].translateTo(g/2-f,a-c+d);this.resizeHandles[5].translateTo(-f,a-c+d);this.resizeHandles[7].translateTo(g-f,a-c+d);for(var b=0;b<8;b++){this.resizeHandles[b].size=this.selectionHandleSize;this.resizeHandles[b].color=this.selectionHandleColor;this.resizeHandles[b].render(e)}}},copy:function(){var a=new CGSGText(this.position.x,this.position.y,this._text);a=this._super(a);this.color="#444444";a.setSize(this._size,false);a.setTextAlign(this._textAlign,false);a.setTextBaseline(this._textBaseline,false);a.setStroke(this._stroke,false);a.setTypo(this._typo,false);a.setMaxWidth(this._maxWidth,false);a.setLineHeight(this._lineHeight,false);a.setWrapMode(this._wrapMode,false);a.setTabulationString(this._tabulation,false);a.pickNodeMethod=this.pickNodeMethod;this.setText(this._text);this.resizeTo(this.getWidth(),this.getHeight());return a}});var CGSGNodeSquare=CGSGNode.extend({initialize:function(b,d,c,a){this._super(b,d,c,a);this.color="#444444";this.lineColor="#222222";this.lineWidth=0;this.classType="CGSGNodeSquare"},render:function(a){this.beforeRender(a);a.globalAlpha=this.globalAlpha;a.fillStyle=this.color;a.strokeStyle=this.lineColor;a.lineWidth=this.lineWidth;a.fillRect(0,0,this.dimension.width,this.dimension.height);a.strokeRect(0,0,this.dimension.width,this.dimension.height);this.afterRender(a)},copy:function(){var a=new CGSGNodeSquare(this.position.x,this.position.y,this.dimension.width,this.dimension.height);a=this._super(a);a.color=this.color;a.lineColor=this.lineColor;a.lineWidth=this.lineWidth;return a}});var CGSGNodeCircle=CGSGNode.extend({initialize:function(b,d,c,a){this._super(b,d,c,a);this.color="#444444";this.lineColor="#222222";this.lineWidth=0;this.classType="CGSGNodeCircle"},render:function(b){this.beforeRender(b);b.globalAlpha=this.globalAlpha;var d=this.dimension.width/2;var c=this.dimension.height/2;var a=Math.min(d,c);b.beginPath();b.arc(d,c,a,0,2*Math.PI,false);b.fillStyle=this.color;b.fill();if(this.lineWidth>0){b.lineWidth=this.lineWidth;b.strokeStyle=this.lineColor;b.stroke()}this.afterRender(b)},copy:function(){var a=new CGSGNodeSquare(this.position.x,this.position.y,this.dimension.width,this.dimension.height);a=this._super(a);a.color=this.color;a.lineColor=this.lineColor;a.lineWidth=this.lineWidth;return a}});var CGSGNodeEllipse=CGSGNode.extend({initialize:function(b,d,c,a){this._super(b,d,c,a);this.color="#444444";this.lineColor="#222222";this.lineWidth=0;this.classType="CGSGNodeEllipse"},render:function(a){this.beforeRender(a);a.globalAlpha=this.globalAlpha;var c=this.dimension.width/2;var b=this.dimension.height/2;a.beginPath();a.moveTo(c,0);a.bezierCurveTo(this.dimension.width,0,this.dimension.width,this.dimension.height,c,this.dimension.height);a.bezierCurveTo(0,this.dimension.height,0,0,c,0);a.fillStyle=this.color;a.fill();if(this.lineWidth>0){a.lineWidth=this.lineWidth;a.strokeStyle=this.lineColor;a.stroke()}a.closePath();this.afterRender(a)},copy:function(){var a=new CGSGNodeSquare(this.position.x,this.position.y,this.dimension.width,this.dimension.height);a=this._super(a);a.color=this.color;a.lineColor=this.lineColor;a.lineWidth=this.lineWidth;return a}});var CGSGNodeImage=CGSGNode.extend({initialize:function(g,e,d,i,b,j,h,f,a,c){this._super(g,e,d,i);this.classType="CGSGNodeImage";this.effect=null;this.urlImage=a;this.isProportionalResize=true;this.img=new Image();this.slice=new CGSGRegion(b,j,h,f);this._isLoaded=false;this._context=c;this.onLoadEnd=null;this.tmpCanvas=document.createElement("canvas");if(this.urlImage!==undefined&&this.urlImage!==null&&this.urlImage!=""){this.img.onload=this.createDelegate(this,this._onImageLoaded,c);this.img.src=this.urlImage}},createDelegate:function(a,c,b){return function(){return c.call(a,b)}},_onImageLoaded:function(a){this._checkDimension();this._isLoaded=true;if(this.onLoadEnd!==null){this.onLoadEnd()}this.initShape();this.render(this._context)},_checkDimension:function(){if(this.dimension.width<=0&&this.dimension.height<=0){this.dimension.width=this.img.width;this.dimension.height=this.img.height}if(this.slice.dimension.width<=0||this.slice.dimension.height<=0){this.slice.dimension.width=this.dimension.width;this.slice.dimension.height=this.dimension.height}},setImage:function(a){this.img=a;if(cgsgExist(this.img)){this.urlImage=this.img.src;this._checkDimension();this._isLoaded=true;this.initShape()}},initShape:function(){this.tmpCanvas.width=this.dimension.width;this.tmpCanvas.height=this.dimension.height;var a=this.tmpCanvas.getContext("2d");a.drawImage(this.img,this.slice.position.x,this.slice.position.y,this.slice.dimension.width,this.slice.dimension.height,0,0,this.dimension.width,this.dimension.height)},render:function(a){if(this._isLoaded&&this.img.src!=""){this.beforeRender(a);a.globalAlpha=this.globalAlpha;a.drawImage(this.tmpCanvas,0,0);this.afterRender(a)}},setEffect:function(a){this.effect=a},renderGhost:function(a){if(this._isLoaded&&this.img.src!=""){this.beforeRenderGhost(a);a.drawImage(this.img,this.slice.position.x,this.slice.position.y,this.slice.dimension.width,this.slice.dimension.height,0,0,this.dimension.width,this.dimension.height);this.afterRenderGhost(a)}},resizeWith:function(b,a){this._super(b,a);this.initShape()},copy:function(){var a=new CGSGNodeImage(this.position.x,this.position.y,this.dimension.width,this.dimension.height,this.slice.position.x,this.slice.position.y,this.slice.dimension.width,this.slice.dimension.height,null,this._context);a=this._super(a);a.urlImage=this.urlImage;a.effect=this.effect;a.isProportionalResize=this.isProportionalResize;a._isLoaded=this._isLoaded;a.setImage(this.img);a.onLoadEnd=this.onLoadEnd;return a}});var CGSGNodeBackground=CGSGNodeImage.extend({initialize:function(c,h,e,b,g,f,a,d){this._super(c,h,e,b);this.classType="CGSGNodeBackground";this.repeatOption=a;this.effect=null;this.urlImage=g;this.bkgColor=f;this.img=new Image();this._context=d;this.isLoaded=false;this.isClickable=false;if(this.urlImage!==null){this.img.onload=this._onImageLoaded(d);this.img.src=this.urlImage}else{this.isLoaded=true}},render:function(a){if(this.isLoaded&&this.img.src!=""){this.beforeRender(a);if(this.urlImage===null){a.fillStyle=this.bkgColor;a.fillRect(0,0,this.dimension.width,this.dimension.height);a.strokeRect(0,0,this.dimension.width,this.dimension.height)}else{if(this.repeatOption===null){a.drawImage(this.img,this.position.x,this.position.y)}else{var b=a.createPattern(this.img,this.repeatOption);a.rect(this.position.x,this.position.y,this.dimension.width,this.dimension.height);a.fillStyle=b;a.fill()}}this.afterRender(a)}},copy:function(){var a=new CGSGNodeBackground(this.position.x,this.position.y,this.dimension.width,this.dimension.height,this.urlImage,this.bkgColor,this.repeatOption,this._context);a=this._super(a);a.effect=this.effect;a.img=this.img;a.isLoaded=this.isLoaded;a.isClickable=this.isClickable;if(this.urlImage!==null){a.img.onload=a._onImageLoaded(a.context);a.img.src=a.urlImage}else{a.isLoaded=true}return a}});var CGSGNodeAnimatedSprite=CGSGNode.extend({initialize:function(a,d,c,b){this._super(a,d,1,1);this.classType="CGSGNodeAnimatedSprite";this.listAnimations=[];this.currentAnimation=null;this.isProportionalResize=true;this.currentFrame=0;this.isPlaying=false;this.numberOfLoops=1;this.currentLoop=0;this.urlImage=c;this.img=new Image();this._isLoaded=false;this._context=b;this.onLoadEnd=null;this.onAnimationEnd=null;this.onAnimationStart=null;this.tmpCanvas=document.createElement("canvas");if(this.urlImage!==null&&this.urlImage!=""){this.img.onload=this.createDelegate(this,this._onImageLoaded,b);this.img.src=this.urlImage}},createDelegate:function(a,c,b){return function(){return c.call(a,b)}},_onImageLoaded:function(a){this._checkDimension();this._isLoaded=true;this.initShape();if(this.onLoadEnd!==null){this.onLoadEnd()}this.render(this._context)},initShape:function(){this.tmpCanvas.width=this.dimension.width;this.tmpCanvas.height=this.dimension.height;var a=this.tmpCanvas.getContext("2d");a.drawImage(this.img,0,0,this.dimension.width,this.dimension.height,0,0,this.dimension.width,this.dimension.height)},_checkDimension:function(){if(this.dimension.width<=0&&this.dimension.height<=0){this.dimension.width=this.img.width;this.dimension.height=this.img.height}},setImage:function(a){this.img=a;this._isLoaded=true;this.initShape()},goToNextFrame:function(){this.currentFrame+=1/this.currentAnimation.speed;var a=false;if(this.currentFrame>=this.currentAnimation.frames){a=true}if(a){if(this.numberOfLoops<0||this.currentLoop<this.numberOfLoops){this.currentLoop++;this.goToFirstFrame()}else{this.goToLastFrame();this.stop()}}},goToPreviousFrame:function(){this.currentFrame-=this.currentAnimation.speed;var a=false;if(this.currentFrame<0){a=true}if(a){if(this.numberOfLoops<=0||this.currentLoop>=0){this.currentLoop--;this.goToLastFrame()}else{this.goToFirstFrame();this.stop()}}},goToFirstFrame:function(){this.currentFrame=0},goToLastFrame:function(){this.currentFrame=this.currentAnimation.frames-1},render:function(a){if(this._isLoaded&&this.img.src!=""){this.beforeRender(a);if(cgsgExist(this.currentAnimation)){a.globalAlpha=this.globalAlpha;var b=this.currentAnimation.slices[Math.floor(this.currentFrame)];a.drawImage(this.img,b.x,b.y,this.currentAnimation.width,this.currentAnimation.height,0,0,this.dimension.width,this.dimension.height);if(this.isPlaying){this.goToNextFrame()}}this.afterRender(a)}},getSlice:function(e,d){var c=e%d.framesPerLine;var b=Math.floor(e/d.framesPerLine);var a=d.sliceX+c*d.width;var f=d.sliceY+b*d.height;return{x:a,y:f}},addAnimation:function(b,d,i,a,k,c,j,e){var g={name:b,speed:d,frames:i,sliceX:a,sliceY:k,width:c,height:j,framesPerLine:e,slices:[]};for(var h=0;h<i;h++){g.slices.push(this.getSlice(h,g))}this.listAnimations.push(g);if(this.listAnimations.length==1){this.currentAnimation=g}},play:function(c,a){if(a===undefined||a===null){a=-1}this.currentAnimation=null;for(var b=0;b<this.listAnimations.length;b++){if(this.listAnimations[b].name===c){this.currentAnimation=this.listAnimations[b];this.reset();this.numberOfLoops=a;this.isPlaying=true;this.resizeTo(this.currentAnimation.width,this.currentAnimation.height);if(this.onAnimationStart!==null){this.onAnimationStart({animationName:c,loop:a})}return true}}return false},stop:function(){this.isPlaying=false;if(this.onAnimationEnd!==null){this.onAnimationEnd({animationName:this.currentAnimation.name,loop:this.currentLoop,frame:this.currentFrame})}},reset:function(){this.currentFrame=0;this.currentLoop=1},copy:function(){var c=new CGSGNodeAnimatedSprite(this.position.x,this.position.y,this.urlImage,this._context);c=this._super(c);c.listAnimations=[];for(var b=0;b<this.listAnimations.length;b++){c.addAnimation(this.listAnimations[b].name,this.listAnimations[b].speed,this.listAnimations[b].frames,this.listAnimations[b].sliceX,this.listAnimations[b].sliceY,this.listAnimations[b].width,this.listAnimations[b].height,this.listAnimations[b].framesPerLine)}c.currentAnimation=this.currentAnimation;c.isProportionalResize=this.isProportionalResize;c.currentFrame=this.currentFrame;c.isPlaying=this.isPlaying;c.numberOfLoops=this.numberOfLoops;c.currentLoop=this.currentLoop;c.img=this.img;c._isLoaded=this._isLoaded;c.onLoadEnd=this.onLoadEnd;c.onAnimationEnd=this.onAnimationEnd;c.onAnimationStart=this.onAnimationStart;if(this.urlImage!==null&&this.urlImage!=""){c.img.onload=c.createDelegate(c,c._onImageLoaded,c.context);c.img.src=c.urlImage}return c}});var CGSGParticle=Object.extend({initialize:function(a){this.node=a;this.node.isClickable=false;this.node.isResizable=false;this.node.isDraggable=false;this.init()},init:function(){this.position=new CGSGPosition(0,0);this.mass=1000;this.initVelocity(new CGSGVector2D(1,1));this.initTTL(50+Math.random()*160);this.isAlive=true;this._gravity=new CGSGVector2D(0,0);this._forceTotal=new CGSGVector2D(0,0);this._acceleration=new CGSGVector2D(0,0);this.speedThreshold=0},initTTL:function(a){this.age=0;this.ttl=a},initPosition:function(a,b){this.position.x=a;this.position.y=b;this.node.translateTo(a,b)},initVelocity:function(a){this.velocity=a.copy();this.velocity.normalize()},initSpeedThreshold:function(a){this.speedThreshold=a},updatePosition:function(a,b){if(isNaN(a)){a=1}a+=this.speedThreshold;this._acceleration.x=b.x/this.mass;this._acceleration.y=b.y/this.mass;this.velocity.x+=this._acceleration.x*a;this.velocity.y+=this._acceleration.y*a;this.position.x+=this.velocity.x*a;this.position.y+=this.velocity.y*a;if(this.node!==null){this.node.translateTo(this.position.x,this.position.y)}this.age+=a;if(this.age>=this.ttl){this.isAlive=false}return this.isAlive}});var CGSGParticleEmitter=CGSGNode.extend({initialize:function(e,g,a,d,h,f,b,c){this._super(g.position.x,g.position.y,g.dimension.width,g.dimension.height);this._node=e;this.region=g;this.nbParticlesMax=a;this.velocity=new CGSGVector2D(0,0);if(cgsgExist(d)){this.velocity=d}this.angle=Math.PI/5;if(cgsgExist(h)){this.angle=h}this.speed=1;if(cgsgExist(f)){this.speed=f}this.speedThreshold=1;if(cgsgExist(b)){this.speedThreshold=b}this.outflow=0;if(cgsgExist(c)){this.outflow=c}this._currentFrame=this.outflow;this._particles=[];this._isPlaying=false;this._forces=[];this._acceleration=new CGSGVector2D(0,0);this.gravity=this.addForce(new CGSGVector2D(0,9.81),null);this.onUpdateParticleEnd=null;this.onInitParticle=null;this.onInitParticlesEnd=null},start:function(){this._isPlaying=true},stop:function(){this._isPlaying=false},reset:function(){this._currentFrame=0;for(var a=this._particles.length-1;a>=0;a--){this.removeChild(this._particles[a].node);delete (this._particles[a])}this._particles.clear()},render:function(a){this.beforeRender(a);this._acceleration.initialize(0,0);for(var b=this._forces.length-1;b>=0;b--){this._acceleration.x+=this._forces[b].vector.x;this._acceleration.y+=this._forces[b].vector.y;if(this._forces[b].ttl!==null){this._forces[b].age++;if(this._forces[b].age>=this._forces[b].ttl){this.removeForce(this._forces[b])}}}for(var c=0;c<this._particles.length;c++){if(this._isPlaying){if(!this.updateParticle(this._particles[c])){this.initParticle(this._particles[c],c)}}this._particles[c].node.render(a)}if(this._particles.length<this.nbParticlesMax){this._currentFrame++;if(this._currentFrame>=this.outflow){this._currentFrame=0;this._createParticle(this._particles.length)}}a.restore()},_createParticle:function(a){var b=new CGSGParticle(this._node.copy());this.initParticle(b,a);this.addChild(b.node);this._particles.push(b)},updateParticle:function(b){var a=b.updatePosition(this.speed,this._acceleration);if(this.onUpdateParticleEnd!==null){this.onUpdateParticleEnd(b)}return a},initParticle:function(d,b){d.init();d.initPosition(Math.random()*this.region.dimension.width,Math.random()*this.region.dimension.height);var c=this.velocity.copy();var a=this.angle/2;c.rotate(-a+Math.random()*this.angle);d.initVelocity(c);d.initSpeedThreshold(-this.speedThreshold+Math.random()*this.speedThreshold*2);if(this.onInitParticle!==null){this.onInitParticle({index:b,particle:d})}},addForce:function(b,a){var c={vector:b,ttl:a,age:0};this._forces.push(c);return c},removeForce:function(a){this._forces.without(a)},addImpulse:function(b,c,a){for(var d=0;d<this._particles.length;d++){this._particles[d].addImpulse(b,c,a)}}});var CGSGParticleSystem=CGSGNode.extend({initialize:function(a,b){this._super(a,b,1,1);this.classType="CGSGParticleSystem";this.emitters=[];this.attractors=[];this.repulsors=[];this.isClickable=false;this.isResizable=false;this.isDraggable=false;this.isTraversable=false},addForce:function(a){for(var b=0;b<this.emitters.length;b++){this.emitters[b].addForce(a)}},addImpulse:function(b,c,a){for(var d=0;d<this.emitters.length;d++){this.emitters[d].addImpulse(b,c,a)}},addEmitter:function(f,i,b,h,g,e,d,c){var a=new CGSGParticleEmitter(f,i,b,h,g,e,d,c);this.addChild(a);this.emitters.push(a);return a},removeEmitter:function(a){this.emitters.without(a);this.removeChild(a)},addAttractor:function(a,c,d){var b={position:a,strength:c,distance:d};this.attractors.push(b)},removeAttractor:function(a){this.attractors.without(a)},addRepulsor:function(a,c,d){var b={position:a,strength:c,distance:d};this.repulsors.push(b)},removRepulsor:function(a){this.repulsors.without(a)},pickNode:function(g,d,c,e,a,b,f){return null},copy:function(){var a=new CGSGParticleSystem()}});var CGSGSceneGraph=Object.extend({initialize:function(a,b){this.root=null;this.context=b;this.canvas=a;cgsgCurrentFrame=0;this.selectedNodes=new Array();this._nextNodeID=1;this._listTimelines=[];this.ghostCanvas=document.createElement("canvas");this.initializeGhost();this.canvas.onselectstart=function(){return false}},initializeGhost:function(b,a){this.ghostCanvas.height=a;this.ghostCanvas.width=b;cgsgGhostContext=this.ghostCanvas.getContext("2d")},_clearContext:function(a){a.setTransform(1,0,0,1,0,0);a.clearRect(0,0,this.canvas.width,this.canvas.height)},render:function(){this._clearContext(this.context);if(this.root!==null&&this.root!==undefined){var e=null;var d=0;var a=0;var c=null;if(this._listTimelines.length>0){e=null;var f=undefined;for(d=0,a=this._listTimelines.length;d<a;++d){e=this._listTimelines[d].parentNode;if(e.isVisible){f=this._listTimelines[d].getValue(cgsgCurrentFrame);if(f!==undefined){e.evalSet(this._listTimelines[d].attribute,f.value)}c=this._listTimelines[d].getFirstKey();if(c!==null&&c.frame==cgsgCurrentFrame&&this._listTimelines[d].onAnimationStart!==null){this._listTimelines[d].onAnimationStart()}c=this._listTimelines[d].getLastKey();if(c!==null&&c.frame==cgsgCurrentFrame){this._listTimelines[d].removeAll();if(this._listTimelines[d].onAnimationEnd!==null){this._listTimelines[d].onAnimationEnd()}}}}}this.context.save();this.context.scale(cgsgDisplayRatio.x,cgsgDisplayRatio.y);if(this.root.isVisible){this.root.render(this.context,cgsgCurrentFrame)}this.context.restore()}if(this.selectedNodes.length>0){for(d=this.selectedNodes.length-1;d>=0;d--){e=this.selectedNodes[d];if(e.isVisible){this.context.save();this.context.scale(cgsgDisplayRatio.x,cgsgDisplayRatio.y);var g=e;var b=g.getAbsolutePosition();this.context.translate(b.x,b.y);this.context.rotate(e._absoluteRotation);this.context.scale(e._absoluteScale.x,e._absoluteScale.y);e.renderSelected(this.context);this.context.restore()}}}cgsgCurrentFrame++},setCanvasDimension:function(a){this.canvas.width=a.x;this.canvas.height=a.y;this.initializeGhost(this.canvas.width,this.canvas.height)},selectNode:function(a){if(!a.isSelected){a.setSelected(true);a.computeAbsoluteMatrix();this.selectedNodes[this.selectedNodes.length]=a}},deselectNode:function(a){a.setSelected(false);this.selectedNodes.without(a)},deselectAll:function(){this._isDrag=false;this._isResizeDrag=false;this._resizingDirection=-1;for(var a=this.selectedNodes.length-1;a>=0;a--){this.deselectNode(this.selectedNodes[a])}this.selectedNodes.clear()},pickNode:function(b,a){this._clearContext(cgsgGhostContext);if(this.root===null||this.root===undefined){return null}else{return this.root.pickNode(b.copy(),new CGSGScale(1,1),cgsgGhostContext,true,this.canvas.width/cgsgDisplayRatio.x,this.canvas.height/cgsgDisplayRatio.y,a)}},removeNode:function(a,b){if(a!==null&&a!==undefined){this.deselectNode(a);if(this.root!==null){return this.root.removeChild(a,b)}}return false},addNode:function(b,a){b._id=this._nextNodeID++;if(this.root===null){this.root=b}else{if(a===null){a=this.root}a.addChild(b)}},addAnimationKey:function(d,c,f,e,g,b){var a=this.getTimeline(d,c);a.method=g;a.addKey(CGSGMath.fixedPoint(f),e);if(b){a.computeValues(cgsgCurrentFrame,g)}},animate:function(d,c,e,h,g,f,a,b){this.addAnimationKey(d,c,cgsgCurrentFrame+CGSGMath.fixedPoint(a),h,f,false);this.addAnimationKey(d,c,cgsgCurrentFrame+CGSGMath.fixedPoint(a+e),g,f,b)},stillHaveAnimation:function(){if(this._listTimelines.length==0){return false}else{for(var b=0,a=this._listTimelines.length;b<a;++b){if(this._listTimelines[b].getLastKey()!==null&&this._listTimelines[b].getLastKey().frame<=cgsgCurrentFrame){return true}}}return false},getTimeline:function(e,d){for(var b=0,a=this._listTimelines.length;b<a;++b){if(this._listTimelines[b].parentNode===e&&this._listTimelines[b].attribute==d){return this._listTimelines[b]}}var c=new CGSGTimeline(e,d,"linear");this._listTimelines.push(c);return c}});var cgsgGlobalRenderingTimer=null;var cgsgGlobalFramerate=CGSG_DEFAULT_FRAMERATE;(function(){var b=0;var c=["ms","moz","webkit","o"];for(var a=0;a<c.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[c[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[c[a]+"CancelAnimationFrame"]||window[c[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(g,e){var d=new Date().getTime();var f=Math.max(0,16-(d-b));cgsgGlobalRenderingTimer=window.setTimeout(function(){g(d+f)},f);b=d+f}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());var CGSGScene=Object.extend({initialize:function(a){cgsgDetectCurrentExplorer();this.canvas=a;this.context=this.canvas.getContext("2d");this.sceneGraph=new CGSGSceneGraph(this.canvas,this.context);this.selectedNodes=this.sceneGraph.selectedNodes;this.fps=0;this._isRunning=false;this._needRedraw=true;this._frameContainer=null;this._keyDownedCtrl=false;this._mousePosition=new CGSGPosition(0,0);this._mouseOldPosition=new CGSGPosition(0,0);this._isDrag=false;this._isResizeDrag=false;this._resizingDirection=-1;this._listCursors=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"];this._offsetX=0;this._offsetY=0;this._selectedNode=null;this._dblCanvas=document.createElement("canvas");this._dblContext=null;var b=this;this.canvas.onmousedown=function(c){b.onMouseDown(c)};this.canvas.onmouseup=function(c){b.onMouseUp(c)};this.canvas.ondblclick=function(c){b.onMouseDblClick(c)};this.canvas.onmousemove=function(c){b.onMouseMove(c)};document.onkeydown=function(c){b.onKeyDownHandler(c)};document.onkeyup=function(c){b.onKeyUpHandler(c)};this.canvas.addEventListener("touchstart",function(c){b.onTouchStart(c)},false);this.canvas.addEventListener("touchmove",function(c){b.onTouchMove(c)},false);this.canvas.addEventListener("touchend",function(c){b.onTouchEnd(c)},false);if(document.defaultView&&document.defaultView.getComputedStyle){cgsgStylePaddingLeft=parseInt(document.defaultView.getComputedStyle(this.canvas,null)["paddingLeft"],10)||0;cgsgStylePaddingTop=parseInt(document.defaultView.getComputedStyle(this.canvas,null)["paddingTop"],10)||0;cgsgStyleBorderLeft=parseInt(document.defaultView.getComputedStyle(this.canvas,null)["borderLeftWidth"],10)||0;cgsgStyleBorderTop=parseInt(document.defaultView.getComputedStyle(this.canvas,null)["borderTopWidth"],10)||0}this._now=0;this._lastUpdate=(new Date)*1-1;this._nodeMouseOver=null;this.onSceneClickStart=null;this.onSceneClickEnd=null;this.onSceneDblClickStart=null;this.onSceneDblClickEnd=null;this.onRenderStart=null;this.onRenderEnd=null},setCanvasDimension:function(a){this.canvas.width=a.x;this.canvas.height=a.y;this.sceneGraph.setCanvasDimension(a);this._dblCanvas.width=a.x;this._dblCanvas.height=a.y;this._dblContext=this._dblCanvas.getContext("2d")},deleteSelected:function(){if(this.sceneGraph.selectedNodes.length>0){for(var a=this.sceneGraph.selectedNodes.length-1;a>=0;a--){this._selectedNode=this.sceneGraph.selectedNodes[a];this.sceneGraph.removeNode(this._selectedNode,true)}}},deselectAll:function(){this._isDrag=false;this._isResizeDrag=false;this.sceneGraph.deselectAll();this.invalidate()},render:function(){if(this._isRunning&&this._needRedraw){if(this.onRenderStart!==null){this.onRenderStart()}this.sceneGraph.render();if(this.onRenderEnd!==null){this.onRenderEnd()}}this._updateFramerate()},startPlaying:function(){var a=this.startPlaying.bind(this);window.requestAnimationFrame(a);this._isRunning=true;this.render()},stopPlaying:function(){window.cancelAnimationFrame(cgsgGlobalRenderingTimer);this._isRunning=false},invalidate:function(){this._needRedraw=true},_updateFramerate:function(){this._now=new Date();this.fps=1000/(this._now-this._lastUpdate);if(this._frameContainer!==null){this._frameContainer.innerText=Math.round(this.fps)}this._lastUpdate=this._now},showFPS:function(a){this._frameContainer=a},setDisplayRatio:function(a){cgsgDisplayRatio=a;this.sceneGraph.initializeGhost(this.canvas.width/cgsgDisplayRatio.x,this.canvas.height/cgsgDisplayRatio.y)},getDisplayRatio:function(){return cgsgDisplayRatio},onMouseDown:function(a){this._clickOnScene(a)},onTouchStart:function(a){this._clickOnScene(a)},_clickOnScene:function(a){if(this.onSceneClickStart!==null){this.onSceneClickStart(a)}this._mousePosition=cgsgGetCursorPosition(a,this.canvas);if(this._resizingDirection!==-1){this._mouseOldPosition=this._mousePosition.copy();this._isResizeDrag=true;if(this.onSceneClickEnd!==null){this.onSceneClickEnd(a)}return}this._selectedNode=this.sceneGraph.pickNode(this._mousePosition,"isClickable===true || this.isDraggable===true || this.isResizable===true");if(this._selectedNode!==null&&this._selectedNode!==undefined){if(this._selectedNode.isDraggable||this._selectedNode.isResizable){if(this._selectedNode.isSelected&&this._keyDownedCtrl){this.sceneGraph.deselectNode(this._selectedNode)}else{this._mouseOldPosition=this._mousePosition.copy();this._isDrag=true;this._isResizeDrag=false;if(!this._selectedNode.isSelected){if(!this._keyDownedCtrl){this.sceneGraph.deselectAll()}this.sceneGraph.selectNode(this._selectedNode)}}this.invalidate()}if(this._selectedNode.isClickable){if(cgsgExist(this._selectedNode.onClick)){this._selectedNode.onClick({node:this._selectedNode,position:this._mousePosition.copy()})}else{if(this._selectedNode.isDraggable===false&&this._selectedNode.isResizable===false){this.deselectAll()}}}}else{this.deselectAll()}if(this.onSceneClickEnd!==null){this.onSceneClickEnd(a)}},onMouseMove:function(a){this._moveOnScene(a)},onTouchMove:function(a){a.preventDefault();a.stopPropagation();this._moveOnScene(a)},_moveOnScene:function(a){this._mousePosition=cgsgGetCursorPosition(a,this.canvas);var e;this._selectedNode=null;if(this._isDrag){if(this.sceneGraph.selectedNodes.length>0){this._offsetX=this._mousePosition.x-this._mouseOldPosition.x;this._offsetY=this._mousePosition.y-this._mouseOldPosition.y;var q=0,o=0;var g=true;for(e=this.sceneGraph.selectedNodes.length-1;e>=0;e--){this._selectedNode=this.sceneGraph.selectedNodes[e];if(this._selectedNode!==null&&this._selectedNode.isDraggable){this._selectedNode.isMoving=true;q=this._offsetX/(this._selectedNode._absoluteScale.x/this._selectedNode.scale.x);o=this._offsetY/(this._selectedNode._absoluteScale.y/this._selectedNode.scale.y);if(this._selectedNode.regionConstraint!==null){var b=this._selectedNode.getRegion().copy();b.position.x+=q;b.position.y+=o;if(!cgsgRegionIsInRegion(b,this._selectedNode.regionConstraint,0)){g=false}}if(g){this._selectedNode.translateWith(q,o);if(this._selectedNode.onDrag!==null){this._selectedNode.onDrag(a)}}}}this._mouseOldPosition=this._mousePosition.copy();this.invalidate()}}else{if(this._isResizeDrag){if(this.sceneGraph.selectedNodes.length>0){this._offsetX=this._mousePosition.x-this._mouseOldPosition.x;this._offsetY=this._mousePosition.y-this._mouseOldPosition.y;var q=0,o=0;for(e=this.sceneGraph.selectedNodes.length-1;e>=0;e--){this._selectedNode=this.sceneGraph.selectedNodes[e];if(this._selectedNode.isResizable){this._selectedNode.isResizing=true;q=this._offsetX/this._selectedNode._absoluteScale.x;o=this._offsetY/this._selectedNode._absoluteScale.y;var m=Math.max(q,o);if(m==0){m=Math.min(q,o)}var r=this._selectedNode.dimension.width*this._selectedNode._absoluteScale.x;var p=this._selectedNode.dimension.height*this._selectedNode._absoluteScale.y;var l=1;switch(this._resizingDirection){case 0:if(this._selectedNode.isProportionalResize){var k=this.getDeltaOnMove(m,q,o,r,p,-1,-1);this._selectedNode.translateWith(-k.dW,-k.dH,false);this._selectedNode.resizeWith(k.dW,k.dH,false)}else{this._selectedNode.translateWith(q*this._selectedNode.scale.x,o*this._selectedNode.scale.y,false);this._selectedNode.resizeWith(-q,-o,false)}break;case 1:this._selectedNode.translateWith(0,o*this._selectedNode.scale.y,false);this._selectedNode.resizeWith(0,-o,false);break;case 2:if(this._selectedNode.isProportionalResize){var k=this.getDeltaOnMove(m,q,o,r,p,1,-1);this._selectedNode.translateWith(0,-k.dH,false);this._selectedNode.resizeWith(k.dW,k.dH,false)}else{this._selectedNode.translateWith(0,o*this._selectedNode.scale.y,false);this._selectedNode.resizeWith(q,-o,false)}break;case 3:this._selectedNode.translateWith(q*this._selectedNode.scale.x,0,false);this._selectedNode.resizeWith(-q,0,false);break;case 4:this._selectedNode.resizeWith(q,0,false);break;case 5:if(this._selectedNode.isProportionalResize){var k=this.getDeltaOnMove(m,q,o,r,p,1,-1);this._selectedNode.translateWith(k.dW,0,false);this._selectedNode.resizeWith(-k.dW,-k.dH,false)}else{this._selectedNode.translateWith(q*this._selectedNode.scale.x,0,false);this._selectedNode.resizeWith(-q,o,false)}break;case 6:this._selectedNode.resizeWith(0,o,false);break;case 7:if(this._selectedNode.isProportionalResize){var k=this.getDeltaOnMove(m,q,o,r,p,1,1);this._selectedNode.resizeWith(k.dW,k.dH,false)}else{this._selectedNode.resizeWith(q,o,false)}break}this._selectedNode.computeAbsoluteMatrix(false);if(this._selectedNode.onResize!==null){this._selectedNode.onResize({node:this._selectedNode})}}}}this._mouseOldPosition=this._mousePosition.copy();this.invalidate()}else{if(this.sceneGraph.selectedNodes.length>0&&this._isResizeDrag==false){for(e=this.sceneGraph.selectedNodes.length-1;e>=0;e--){this._selectedNode=this.sceneGraph.selectedNodes[e];if(this._selectedNode.isResizable){for(var f=0;f<8;f++){var j=this._selectedNode.resizeHandles[f];if(j.checkIfSelected(this._mousePosition,cgsgResizeHandleThreshold)){this._resizingDirection=f;this.canvas.style.cursor=this._listCursors[f];return}}}}this._isResizeDrag=false;this._resizingDirection=-1;this.canvas.style.cursor="auto";this.invalidate()}}}if(!this._isDrag&&!this._isResizeDrag){var c=null;if(cgsgExist(this._nodeMouseOver)){c=this._nodeMouseOver.pickNode(this._mousePosition,null,cgsgGhostContext,false,this.canvas.width,this.canvas.height,null);if(c===null){this._nodeMouseOver.isMouseOver=false;if(cgsgExist(this._nodeMouseOver.onMouseOut)){this._nodeMouseOver.onMouseOut({node:this._nodeMouseOver,position:this._mousePosition.copy()})}this._nodeMouseOver=null}}if(c===null){if((c=this.sceneGraph.pickNode(this._mousePosition,"onMouseOver !== null"))!==null){c.isMouseOver=true;this._nodeMouseOver=c;this._nodeMouseOver.onMouseOver({node:this._nodeMouseOver,position:this._mousePosition.copy()})}}}},getDeltaOnMove:function(i,k,j,g,e,c,b){var d=k,a=j;var f=1;if(i==k){f=(g+c*i)/g;d=c*i;a=(f-1)*e}else{f=(e+b*i)/e;a=b*i;d=(f-1)*g}return{dW:d,dH:a}},onMouseUp:function(a){this._upOnScene(a)},onTouchEnd:function(a){this._upOnScene(a)},_upOnScene:function(b){var a=0;if(this._isDrag){for(a=this.sceneGraph.selectedNodes.length-1;a>=0;a--){this._selectedNode=this.sceneGraph.selectedNodes[a];if(this._selectedNode.isMoving){this._selectedNode.isMoving=false;this._selectedNode.computeAbsoluteMatrix(true);if(this._selectedNode.onDragEnd!==null){this._selectedNode.onDragEnd(b)}}}this._isDrag=false}if(this._isResizeDrag){for(a=this.sceneGraph.selectedNodes.length-1;a>=0;a--){this._selectedNode=this.sceneGraph.selectedNodes[a];if(this._selectedNode.isResizing){this._selectedNode.isResizing=false;this._selectedNode.computeAbsoluteMatrix(true);if(this._selectedNode.onResizeEnd!==null){this._selectedNode.onResizeEnd(b)}}}this._isResizeDrag=false}this._resizingDirection=-1},onMouseDblClick:function(a){this.dblClickOnScene(a)},dblClickOnScene:function(a){if(this.onSceneDblClickStart!==null){this.onSceneDblClickStart(a)}this._mousePosition=cgsgGetCursorPosition(a,this.canvas);this._selectedNode=this.sceneGraph.pickNode(this._mousePosition);if(cgsgExist(this._selectedNode)&&this._selectedNode.onDblClick!==null){this._selectedNode.onDblClick({node:this._selectedNode,position:this._mousePosition.copy()})}else{if(this.onSceneDblClickEnd!==null){this.onSceneDblClickEnd({node:this._selectedNode,position:this._mousePosition.copy()})}}return this._selectedNode},onKeyDownHandler:function(a){var b=(window.event)?a.keyCode:a.which;switch(b){case 17:this._keyDownedCtrl=true;break}return b},onKeyUpHandler:function(a){var b=(window.event)?a.keyCode:a.which;switch(b){case 17:this._keyDownedCtrl=false;break}return b}});